<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lifeline</title>

<!--if lt IE 9]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<!-- <script src="js/jquery/jquery-3.2.1.min.js"></script> -->
<script src="js/jquery/jquery-1.11.1.min.js"></script>
<script src="js/d3/d3.min.js"></script>
<!-- calendar -->
<link rel="stylesheet" type="text/css" href="css/fullcalendar/fullcalendar.css">
<!-- <link href='./css/fullcalendar.print.min.css' rel='stylesheet' media='print' /> -->

<!-- <script src="js/fullcalendar/moment.min.js"></script>
<script src="js/fullcalendar/fullcalendar.min.js"></script>
<script src="js/fullcalendar/locale-all.js"></script> -->

<!-- jquery date-time picker -->
<!-- <link rel="stylesheet" type="text/css" href="css/jquery/jquery-ui.min.css">
<link rel="stylesheet" type="text/css" href="css/jquery/jquery-ui-timepicker-addon.css">
<script src="js/jquery/jquery-ui.min.js"></script>
<script src="js/jquery/timepicker/jquery-ui-timepicker-addon.js"></script>
<script src="js/jquery/i18n/datepicker-de.js"></script>
<script src="js/jquery/i18n/datepicker-es.js"></script>
<script src="js/jquery/i18n/datepicker-fr.js"></script>
<script src="js/jquery/i18n/datepicker-it.js"></script>
<script src="js/jquery/i18n/datepicker-ja.js"></script>
<script src="js/jquery/i18n/datepicker-ko.js"></script>
<script src="js/jquery/i18n/datepicker-ru.js"></script>
<script src="js/jquery/i18n/datepicker-th.js"></script>
<script src="js/jquery/i18n/datepicker-zh-TW.js"></script>
<script src="js/jquery/i18n/datepicker-zh-CN.js"></script>
<script src="js/jquery/i18n/jquery-ui-timepicker-addon-i18n.min.js"></script> -->
<!-- Bootstrap -->
<link rel="stylesheet" href="css/bootstrap/bootstrap.css">
<script src="js/bootstrap/bootstrap.min.js"></script>
<!-- bootstrap-datetimepicker -->
<!--     
<link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-datetimepicker.min.css">
<script src="js/bootstrap/bootstrap-datetimepicker.min.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.zh-CN.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.zh-TW.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.de.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.es.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.fr.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.it.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.ja.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.ko.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.ru.js"></script>
<script src="js/bootstrap/locales/bootstrap-datetimepicker.th.js"></script> -->

<link rel="stylesheet" type="text/css" href="css/ddl.css">
<link rel="stylesheet" type="text/css" href="css/timeline.css">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<script src="js/bootstrap/css3-mediaqueries.min.js"></script>
<![endif]-->

<style type="text/css">
 .class-item{
    margin-bottom: 10px;
    word-wrap: break-word;
  }
</style>
</head>

<body>
<nav class="navbar navbar-default">
  <div class="container"> 
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" data-toggle="collapse" data-target="#myDefaultNavbar1" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="lifeline.html">Lifeline </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="myDefaultNavbar1">
      <ul class="nav navbar-nav">
        <li>
          <a href="lifeline.html">主页 </a>
        </li>
         <li>
          <a href="add_my_event.html" >添加个人事件 </a>
        </li>
        <li class="active"><a href="#">添加课堂 <span class="sr-only">(current)</span></a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a id="settings" href="my_classes.html"><span class="glyphicon glyphicon-cog"></span>&nbsp;我的课堂</a>
        </li>
        <li>
          <a id="logout" href="php/log_out.php"><span class="glyphicon glyphicon-log-out"></span>&nbsp;退出登录</a>
        </li>

      </ul>
    </div>
    <!-- .navbar-collapse --> 
  </div>
  <!-- .container --> 
</nav>

<div class = "container">
    <div style="text-align: center; word-wrap: break-word;">

      <h2>添加课堂</h2>
      <p>想要删除课堂？点击进入管理<a href="my_classes.html">我的课堂</a></p>
      <br />
    </div>
    <form class = "form-horizontal" id="form" role = "role" >
        <div class = "form-group">
            <!--<label for="term" class="col-sm-2 col-sm-offset-2 control-label">课程查询</label>-->
            <div class='col-sm-4 col-sm-offset-4' >
                <input type='text' class="form-control" id='keywords' name="keywords" placeholder="请输入课程的相关信息" />
            </div>
            
        </div>
        <div class="form-group">
            <div class="col-sm-offset-4 col-sm-2">
                <button type="submit" class="btn btn-block btn-primary">查询</button>
            </div>
            <div class=" col-sm-2">
                <button type="reset" class="btn btn-block" >重置</button>
            </div>
        </div>
    </form>
    <div class='col-sm-6 col-sm-offset-4'>
        <h5 style="line-height:200%">
            <text style="color:red">*</text>&nbsp;支持对班级名、创建者、教师姓名、课程名称、课程编号等进行查询<br/>
            <text style="color:red">*</text>&nbsp;关键字之间请用空格隔开<br/>
            <text style="color:red">*</text>&nbsp;如输入“现代软件工程 邓宏平”<br/>
        </h5>
    </div>
</div>


<!-- 模态框（Modal） -->
  <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" id="about-header" style="text-align: right;">
            <button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">关闭</button> 
        </div>
        <!-- <div class="modal-body" id="svg-div" style="height:400px; overflow:auto"> -->
        <div class="modal-body" id="about-div" style="overflow:auto">
          <div style="font-family: 'Microsoft Yahei';">
            <p><b>Lifeline</b>是一款展示日常事件日程的应用，专为在校大学生设计。</p>
            <p>目前Lifeline专为USTCer打造，各种deadline、社团活动、个人事件您可以轻松获取和管理。</p>
            <p>通过添加“我的课程”，您可以跟踪课程助教和老师发布的作业、报告、小测、考试等事件。通过添加“个人事件”，您可以加入个人私密事件信息。</p>
            <p>登录Lifeline，您即可获取自己所关心的全部事件~</p>
          </div>
        </div> <!-- .modal-body -->
      </div> <!-- /.modal-content -->
    </div> <!-- /.modal -->
  </div> <!-- #aboutModal -->

<!-- footer -->
<div class="container"></div>
<hr>
<footer class="footer">
  <div class="container">
    <div class="row footer-top">
      <div class="col-sm-4 col-lg-4">
        <h4>
          BlueWhale
          <!-- <img src="#"> -->
        </h4>
        <p>蓝鲸出品</p>
      </div>
      <div class="col-sm-8  col-lg-7 col-lg-offset-1">
        <div class="row about">
          <div class="col-xs-6">
            <h4>关于</h4>
            <ul class="list-unstyled">
              <li onclick="$('#aboutModal').modal('show')" style="cursor: pointer;"><a>关于我们</a></li>
            </ul>
          </div>
          <div class="col-xs-6">
            <h4>联系方式</h4>
            <ul class="list-unstyled">
              <li><a href="mailto:1529825719@qq.com">电子邮件</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <hr>
    <div class="row footer-bottom">
      <ul class="list-inline text-center">
        Copyright © BlueWhale. All rights reserved.
      </ul>
    </div>
  </div>
</footer>


<!-- Search Result Modal -->
<div class="modal fade" id="myModal_searchResult" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="text-align: right;">

        <div class = "pull-right" >
          <button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">关闭</button>
        </div>
        
        <div class = "text-center">
          <!--提示共N条查询结果-->
          <h4 id = "num_result"></h4>
        </div>

      </div>

      <div class="modal-body" id = "list-div" style="overflow:auto">
        <!--
        <ul class="list-group" id="list-group">            
        </ul>
        -->
      </div>

    </div><!-- /.modal-content -->
  </div><!-- /.modal -->
</div>



<script>
var class_selected = []
$(document).ready(function() {
  $("#form").submit(function() {
    $.ajax({
      type: "post",
      data: $("#form").serialize(),
      url: "php/search_classes.php",
      dataType: "json",
      success: function(responseText, textStatus) {
        console.log("数据获取成功！")
        console.log('responseText:',responseText)
        class_selected = responseText
        view_searchResult()
      },
      error: function(xhr, status, error) {
        console.log('xhr: ', xhr, 'status: ', status, 'error: ', error)
        alert('获取课堂数据失败  ..>_<..  确认登录了吗？ 试试联系我们吧~')
        window.location.href='http://106.14.116.49/lifeline/login.html'
      }
    })
    return false
  })
})

 function searchResult_display () {

    if((class_selected.length == 1 && class_selected[0].class_name === undefined) || class_selected == null || class_selected.length == 0){
        // $('#list-div').height('0px')
        d3.select('#num_result')
          .text("没有找到相关课堂")
        d3.select('#list-div').html('<div class="class-item list-group-item"><span style="color:red">*</span>&nbsp;已经在<span style="font-weight: bold;">Lifeline</span>上创建的课堂才能查询到哦！<br /><br /><span style="color:red">*</span>&nbsp;查询不到您所在的课堂？快请助教或教师在<span style="font-weight: bold;">Lifeline</span>上创建课堂吧！</div>')
        return
    }
    
    var i, index_end = class_selected.length
    d3.select('#num_result')
       .text('共找到' + index_end + '条结果')

    var items = d3.select('#list-div').selectAll('.class-item').data(class_selected).enter()
      .append('div').classed('class-item',true)
      .attr('id', function(d, i){return 'list-group' + i}) // id
    items.append('div') // item title
      .classed('list-group-item active', true)
      .text(function(d){return d.class_name})
      .append('button') // add button
          .classed('btn btn-default pull-right btn-xs', true)
          .attr('disabled',function(d){if(d.role!==undefined){return 'disabled'}else{return null}})
          .on('click', function(d,i){Add_class_by_class_name(d,i)})
          .text(function(d){if(d.role!==undefined){return '已添加'}else{return '添加'}})
    items.append('div')
      .html(function(d,i){
        return '<div class="list-group-item">创建者：'+
          d.founder+
          '</div><div class="list-group-item">任课教师：'+d.teacher+
          '</div><div class="list-group-item">课程名称：'+d.course_name+
          '</div><div class="list-group-item">课程编号：'+d.course_no+
          '</div>'
      })


function Add_class_by_class_name (d, index) {
  console.log('class_name:',d.class_name)
  // var evnt_dtd = $.Deferred();
  return $.ajax({
    type: 'POST',
  // url: './php/test1.php', // 这里写PHP文件路径
    url: 'php/add_class.php',
    data: {
            class_name: d.class_name,
          }, // 这里写要发送的数据，{key: value}格式。这边的key请设置成与数据库中一致
    dataType: 'text', 
    beforeSend: function (xhr) {
      // console.log('xhr: ', xhr)
    },
    success: function (responseText, textStatus) {
    // responseText: php返回内容
      // console.log(typeof(responseText))
      console.log('数据获取成功')
      // console.log('textStatus:', textStatus)
      console.log('responseText:',responseText, typeof(responseText))
      if(responseText == '1'){
        alert('成功添加课堂：'+d.class_name+'（'+d.teacher+'）, 创建者：'+d.founder+'')
        d3.select('#list-group'+index).select('button').attr('disabled','disabled').text('已添加')
      }
      else{
        alert('出错！添加课堂失败：'+d.class_name+'（'+d.teacher+'）, 创建者：'+d.founder+'')
      }
      // console.log('events_arr changed:', events_arr)
      // // events_json=eval(responseText)
      // // console.log('events_json: \n', events_json)
      // // console.log(typeof(events_json));
      // // events_arr = events_json
      // // evnt_dtd.resolve()
    },
    error: function(xhr, status, error) {
      console.log('Fail to connect to database! ')
      console.log('xhr: ', xhr, 'status: ', status, 'error: ', error)
      alert('出错！添加课堂失败：'+d.class_name+'（'+d.teacher+'）, 创建者：'+d.founder+'')   
    // 提交失败
    }
  })
  // console.log('ajax events_o before return: ',events_o)
  // return evnt_dtd.promise(); // 返回promise对象
}

 }

  function ResizeModalBodyClass(){
    var adjust = 120
    var svgDivHeight = $(window).height() - adjust
    $('#list-div').height(svgDivHeight + 'px')
  }

 function view_searchResult () {
   $('#myModal_searchResult').on('shown.bs.modal', function () {
    searchResult_display()
  })
   $('#myModal_searchResult').on('hide.bs.modal', function () {
    d3.select('#list-div')
      .selectAll('.class-item')
      .remove()
    d3.select('#num_result')
      .text('')
    })
  window.onresize = ResizeModalBodyClass
  ResizeModalBodyClass()
  $('#myModal_searchResult').modal('show')
 }
</script>
</body>
</html>